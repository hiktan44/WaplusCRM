<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRCHIEFS Toplu Mesaj + Bro≈ü√ºr Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üíå HAIRCHIEFS Toplu Mesaj + Bro≈ü√ºr</h1>
                    <p class="text-gray-600">Profesyonel ≈üablonlarla toplu WhatsApp mesajƒ± + HAIRCHIEFS bro≈ü√ºr√º g√∂nderin</p>
                </div>

                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-xl font-semibold mb-4">üìã 1. Ki≈üi Listesi</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CSV/Excel Dosyasƒ± Y√ºkle</label>
                                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Dosya formatƒ±: name,phone (√∂rn: Ahmet Yƒ±lmaz,905551234567)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Manuel Giri≈ü</label>
                                <textarea id="manualInput" rows="4" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          placeholder="Ahmet Yƒ±lmaz,905551234567&#10;Mehmet Demir,905559876543"></textarea>
                            </div>
                            
                            <button onclick="loadContacts()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                                üìù Ki≈üileri Y√ºkle
                            </button>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-xl font-semibold mb-4">üí¨ 2. Mesaj ≈ûablonu + Bro≈ü√ºr</h2>
                        <div class="space-y-4">
                            <select id="templateSelect" onchange="selectTemplate()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">≈ûablon Se√ßin...</option>
                                <option value="partnership">ü§ù Ortaklƒ±k Fƒ±rsatƒ±</option>
                                <option value="promotion">‚úÇÔ∏è Sa√ß Ekimi Promosyonu</option>
                                <option value="consultation">üë®‚Äç‚öïÔ∏è √úcretsiz Kons√ºltasyon</option>
                                <option value="success">‚≠ê Ba≈üarƒ± Hikayesi</option>
                            </select>
                            
                            <textarea id="messageTemplate" rows="8" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Mesaj ≈üablonunu se√ßin veya kendiniz yazƒ±n..."></textarea>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üìé Dosya Ekleri (Resim, Video, PDF)</label>
                                
                                <div class="space-y-3">
                                    <!-- File Upload Button -->
                                    <button onclick="document.getElementById('fileUploadInput').click()" 
                                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                                        üì§ Dosya Y√ºkle (√áoklu - Resim, Video, PDF)
                                    </button>
                                    <input type="file" id="fileUploadInput" multiple class="hidden" 
                                           accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.mp3,.wav,.zip,.rar">
                                    
                                    <!-- Selected Files Display -->
                                    <div id="selectedFilesDisplay" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">üîó Se√ßili Dosyalar:</label>
                                        <div id="selectedFilesList" class="space-y-2"></div>
                                        <button onclick="clearSelectedFiles()" 
                                                class="mt-2 text-red-600 text-sm hover:text-red-800">
                                            üóëÔ∏è T√ºm Dosyalarƒ± Temizle
                                        </button>
                                    </div>
                                    
                                    <!-- Available Files -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Mevcut Dosyalar:</label>
                                        <div id="availableFilesList" class="space-y-2 max-h-40 overflow-y-auto border rounded-md p-2">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox" id="file_hairchiefs-brochure.pdf" class="file-checkbox" value="hairchiefs-brochure.pdf">
                                                <label for="file_hairchiefs-brochure.pdf" class="text-sm">üìÑ HAIRCHIEFS Bro≈ü√ºr√º</label>
                                            </div>
                                        </div>
                                        <button onclick="loadAvailableFiles()" 
                                                class="mt-2 w-full bg-gray-600 text-white py-1 px-3 rounded-md hover:bg-gray-700 transition duration-200 text-sm">
                                            üîÑ Dosya Listesini Yenile
                                        </button>
                                    </div>
                                </div>
                                
                                <p class="text-xs text-green-600 mt-2">‚ú® Resim, video ve PDF ile daha etkili sonu√ßlar alƒ±n!</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">G√∂nderim Aralƒ±ƒüƒ± (saniye)</label>
                                <input type="number" id="delayInput" value="5" min="1" max="30" autocomplete="off"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-yellow-600 mt-1">‚ö†Ô∏è Bro≈ü√ºr ile g√∂nderim biraz daha uzun s√ºrer</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">üìä Ki≈üi Listesi ve Durum</h3>
                    
                    <!-- Contact Selection -->
                    <div id="contactSelectionContainer" class="mb-4 hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium text-gray-700">üë• Ki≈üi Se√ßimi:</h4>
                            <div class="space-x-2">
                                <button onclick="selectAllContacts()" class="text-sm bg-blue-500 text-white px-2 py-1 rounded">‚úÖ T√ºm√º</button>
                                <button onclick="selectNone()" class="text-sm bg-gray-500 text-white px-2 py-1 rounded">‚ùå Hi√ßbiri</button>
                                <button onclick="selectFirst3()" class="text-sm bg-green-500 text-white px-2 py-1 rounded">üî¢ ƒ∞lk 3 (Test)</button>
                            </div>
                        </div>
                        <div id="contactCheckboxList" class="space-y-2 max-h-60 overflow-y-auto border rounded-md p-3 bg-white">
                            <!-- Contact checkboxes will be populated here -->
                        </div>
                        <div id="selectionSummary" class="mt-2 text-sm text-blue-600"></div>
                    </div>
                    
                    <div id="contactList" class="mb-4"></div>
                    <div id="progressContainer" class="hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                            <div id="progressBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-gray-600">Hazƒ±rlanƒ±yor...</p>
                    </div>
                    <button id="sendButton" onclick="toggleSending()" disabled 
                            class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                        üöÄ Mesaj + Bro≈ü√ºr G√∂ndermeyi Ba≈ülat
                    </button>
                    <button id="stopButton" onclick="stopSending()" style="display: none;" 
                            class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition duration-200 font-medium mt-2">
                        ‚èπÔ∏è G√∂ndermeyi Durdur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const templates = {
            partnership: `üí´ Merhaba {name}! ‚ú®

üî• HAIRCHIEFS'ten size √ñZEL fƒ±rsat! 

üéØ KUAF√ñR ORTAKLIK PROGRAMI
‚úÖ %20'ye varan komisyon oranƒ±
‚úÖ 50.000‚Ç∫ kredi imkanƒ± (6 taksit)
‚úÖ 8 yƒ±llƒ±k deneyim & 30.000+ ba≈üarƒ±lƒ± i≈ülem
‚úÖ 4000 m¬≤ alan & modern teknoloji

üìé Detaylƒ± bilgi i√ßin ekteki bro≈ü√ºr√º inceleyin!

üì± Hemen ileti≈üim:
‚òéÔ∏è 0544 675 71 13

üì§ Abonelikten √ßƒ±kmak i√ßin "abonelikten √ßƒ±k" yazƒ±n

#HAIRCHIEFS #Sa√ßEkimi #Ortaklƒ±k`,

            promotion: `üåü Merhaba {name}! 

‚úÇÔ∏è HAIRCHIEFS √ñZEL KAMPANYA! 

üéÅ SADECE BU AY:
‚úÖ Sa√ß ekiminde %25 indirim
‚úÖ √úcretsiz sa√ß analizi
‚úÖ 12 ay garanti
‚úÖ VIP transfer hizmeti

üë®‚Äç‚öïÔ∏è 8 yƒ±llƒ±k tecr√ºbe ile 30.000+ memnun hasta!

üìé Kampanya detaylarƒ± ekte!

üìû Randevu i√ßin hemen arayƒ±n:
‚òéÔ∏è 0544 675 71 13

üì§ Abonelikten √ßƒ±kmak i√ßin "abonelikten √ßƒ±k" yazƒ±n

#HAIRCHIEFS #Sa√ßEkimi #Kampanya`,

            consultation: `üëã Merhaba {name}!

üë®‚Äç‚öïÔ∏è √úCRETSIZ UZMAN KONS√úLTASYONU

üî¨ HAIRCHIEFS'ten size √∂zel:
‚úÖ Sa√ß d√∂k√ºlmesi analizi
‚úÖ Ki≈üisel tedavi planƒ±
‚úÖ 3D sa√ß sim√ºlasyonu
‚úÖ Fiyat bilgilendirme

üè• 30.000+ ba≈üarƒ±lƒ± operasyon tecr√ºbesi
‚≠ê 4.9 Google puanƒ± ile g√ºvenilir hizmet

üìé Hizmetlerimiz hakkƒ±nda detaylar ekte!

üì± Hemen √ºcretsiz analiz i√ßin:
‚òéÔ∏è 0544 675 71 13

üì§ Abonelikten √ßƒ±kmak i√ßin "abonelikten √ßƒ±k" yazƒ±n

#HAIRCHIEFS #Sa√ßAnalizi #√úcretsizKons√ºltasyon`,

            success: `üéâ Merhaba {name}!

‚≠ê HAIRCHIEFS BA≈ûARI Hƒ∞KAYESƒ∞

üìà 8 yƒ±llƒ±k tecr√ºbemizle:
‚úÖ 30.000+ memnun hasta
‚úÖ %99 ba≈üarƒ± oranƒ±  
‚úÖ 4.9 Google yorumu
‚úÖ Doƒüal g√∂r√ºn√ºm garantisi

üí¨ "Hayalindeki sa√ßlara kavu≈ütum!" 
- Memnun hastalarƒ±mƒ±zdan...

üìé Ba≈üarƒ± hikayelerimiz ekte!

üèÜ T√ºrkiye'nin en g√ºvenilir sa√ß ekimi merkezi

üìû Siz de aramƒ±za katƒ±lƒ±n:
‚òéÔ∏è 0544 675 71 13

üì§ Abonelikten √ßƒ±kmak i√ßin "abonelikten √ßƒ±k" yazƒ±n

#HAIRCHIEFS #Ba≈üarƒ±Hikayesi #Sa√ßEkimi`
        };

        let contacts = [];
        let isSending = false;
        let shouldStop = false;
        let selectedFiles = [];
        let currentInstance = 'hairchiefs-wa';

        function selectTemplate() {
            const templateKey = document.getElementById('templateSelect').value;
            if (templateKey && templates[templateKey]) {
                document.getElementById('messageTemplate').value = templates[templateKey];
                // Otomatik olarak bro≈ü√ºr√º se√ß - checkbox ile
                const bro≈ü√ºrCheckbox = document.getElementById('file_hairchiefs-brochure.pdf');
                if (bro≈ü√ºrCheckbox) {
                    bro≈ü√ºrCheckbox.checked = true;
                    updateSelectedFiles();
                }
            }
        }

        function loadContacts() {
            contacts = [];
            
            const fileInput = document.getElementById('fileInput');
            const manualInput = document.getElementById('manualInput').value.trim();
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        if (file.name.endsWith('.csv')) {
                            parseCSV(e.target.result);
                        } else {
                            parseExcel(e.target.result);
                        }
                    } catch (error) {
                        alert('Dosya okuma hatasƒ±: ' + error.message);
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            } else if (manualInput) {
                parseCSV(manualInput);
            } else {
                alert('L√ºtfen dosya y√ºkleyin veya manuel olarak ki≈üi girin!');
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            contacts = [];
            
            // First line might be header, check if it contains phone-like pattern
            let startIndex = 0;
            if (lines.length > 0) {
                const firstLine = lines[0];
                // If first line doesn't contain numbers that look like phone numbers, skip it (header)
                if (!firstLine.match(/\d{10,}/)) {
                    startIndex = 1;
                }
            }
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                const parts = line.split(',').map(s => s.trim());
                
                if (parts.length >= 2) {
                    let name = '';
                    let phone = '';
                    
                    // Try to detect which part is phone number
                    for (let j = 0; j < parts.length; j++) {
                        let part = parts[j].replace(/[^\d+]/g, '');
                        
                        // Turkish phone number formatting on client side
                        if (part.startsWith('0') && part.length === 11) {
                            part = '9' + part; // 05551234567 -> 905551234567
                        } else if (part.startsWith('5') && part.length === 10) {
                            part = '90' + part; // 5551234567 -> 905551234567
                        } else if (!part.startsWith('90') && part.length === 10) {
                            part = '90' + part; // Any 10-digit -> 90xxxxxxxxxx
                        }
                        
                        if (part.length >= 10) { // This looks like a phone number
                            phone = part;
                            // The other parts are likely name/business name
                            name = parts.filter((p, idx) => idx !== j).join(' ').trim();
                            break;
                        }
                    }
                    
                    // Fallback: assume first column is name, second is phone
                    if (!phone) {
                        name = parts[0];
                        let rawPhone = parts[1].replace(/[^\d+]/g, '');
                        
                        // Apply Turkish formatting to fallback phone
                        if (rawPhone.startsWith('0') && rawPhone.length === 11) {
                            phone = '9' + rawPhone;
                        } else if (rawPhone.startsWith('5') && rawPhone.length === 10) {
                            phone = '90' + rawPhone;
                        } else if (!rawPhone.startsWith('90') && rawPhone.length === 10) {
                            phone = '90' + rawPhone;
                        } else {
                            phone = rawPhone;
                        }
                    }
                    
                    // Validate phone number
                    if (phone && phone.length >= 10 && name) {
                        contacts.push({name, phone});
                        console.log(`Parsed contact: ${name} -> ${phone}`);
                    } else {
                        console.warn(`Skipped invalid contact: ${line}`);
                    }
                }
            }
            
            updateContactList();
        }

        function parseExcel(binaryStr) {
            const workbook = XLSX.read(binaryStr, {type: 'binary'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            contacts = [];
            
            // Skip first row if it looks like headers
            let startIndex = 0;
            if (data.length > 0) {
                const firstRow = data[0];
                // If first row doesn't contain numbers that look like phone numbers, skip it
                const hasPhoneNumber = firstRow.some(cell => {
                    if (typeof cell === 'string' || typeof cell === 'number') {
                        const cleaned = cell.toString().replace(/[^\d]/g, '');
                        return cleaned.length >= 10;
                    }
                    return false;
                });
                if (!hasPhoneNumber) {
                    startIndex = 1;
                }
            }
            
            for (let i = startIndex; i < data.length; i++) {
                const row = data[i];
                if (row && row.length >= 2) {
                    let name = '';
                    let phone = '';
                    
                    // Try to detect which column contains phone number
                    for (let j = 0; j < row.length; j++) {
                        const cell = row[j];
                        if (cell) {
                            let cleaned = cell.toString().replace(/[^\d+]/g, '');
                            
                            // Turkish phone number formatting for Excel
                            if (cleaned.startsWith('0') && cleaned.length === 11) {
                                cleaned = '9' + cleaned; // 05551234567 -> 905551234567
                            } else if (cleaned.startsWith('5') && cleaned.length === 10) {
                                cleaned = '90' + cleaned; // 5551234567 -> 905551234567
                            } else if (!cleaned.startsWith('90') && cleaned.length === 10) {
                                cleaned = '90' + cleaned; // Any 10-digit -> 90xxxxxxxxxx
                            }
                            
                            if (cleaned.length >= 10) { // This looks like a phone number
                                phone = cleaned;
                                // The other cells are likely name/business name
                                name = row.filter((c, idx) => idx !== j && c).join(' ').trim();
                                break;
                            }
                        }
                    }
                    
                    // Fallback: assume first column is name, second is phone
                    if (!phone && row[0] && row[1]) {
                        name = row[0].toString();
                        let rawPhone = row[1].toString().replace(/[^\d+]/g, '');
                        
                        // Apply Turkish formatting to fallback phone too
                        if (rawPhone.startsWith('0') && rawPhone.length === 11) {
                            phone = '9' + rawPhone;
                        } else if (rawPhone.startsWith('5') && rawPhone.length === 10) {
                            phone = '90' + rawPhone;
                        } else if (!rawPhone.startsWith('90') && rawPhone.length === 10) {
                            phone = '90' + rawPhone;
                        } else {
                            phone = rawPhone;
                        }
                    }
                    
                    // Validate and add contact
                    if (phone && phone.length >= 10 && name) {
                        contacts.push({name, phone});
                        console.log(`Excel parsed contact: ${name} -> ${phone}`);
                    } else {
                        console.warn(`Excel skipped invalid row:`, row);
                    }
                }
            }
            
            updateContactList();
        }

        function updateContactList() {
            const listElement = document.getElementById('contactList');
            const selectionContainer = document.getElementById('contactSelectionContainer');
            const checkboxList = document.getElementById('contactCheckboxList');
            
            if (contacts.length > 0) {
                // Show contact selection
                selectionContainer.classList.remove('hidden');
                
                // Create checkboxes for each contact
                checkboxList.innerHTML = contacts.map((contact, index) => `
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="contact_${index}" class="contact-checkbox" value="${index}" onchange="updateContactSelection()" checked>
                        <label for="contact_${index}" class="text-sm cursor-pointer">üìû ${contact.name} (${contact.phone})</label>
                    </div>
                `).join('');
                
                // Show summary
                listElement.innerHTML = `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-green-800 font-medium">üìû ${contacts.length} ki≈üi y√ºklendi!</p>
                        <div class="mt-2 text-sm text-green-600">
                            ${contacts.slice(0, 3).map(c => `‚Ä¢ ${c.name} (${c.phone})`).join('<br>')}
                            ${contacts.length > 3 ? `<br><em>... ve ${contacts.length - 3} ki≈üi daha</em>` : ''}
                        </div>
                    </div>
                `;
                
                updateContactSelection();
            } else {
                selectionContainer.classList.add('hidden');
                listElement.innerHTML = `
                    <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-800">‚ùå Ki≈üi listesi bo≈ü!</p>
                    </div>
                `;
                document.getElementById('sendButton').disabled = true;
            }
        }

        // Update contact selection
        function updateContactSelection() {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const summary = document.getElementById('selectionSummary');
            
            summary.textContent = `üéØ ${selectedCount} ki≈üi se√ßildi (${contacts.length} ki≈üiden)`;
            
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = selectedCount === 0;
            sendButton.textContent = selectedCount > 0 
                ? `üöÄ ${selectedCount} Ki≈üiye Mesaj + Ek G√∂nder`
                : 'üöÄ Mesaj + Bro≈ü√ºr G√∂ndermeyi Ba≈ülat';
        }

        // Contact selection functions
        function selectAllContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateContactSelection();
        }

        function selectNone() {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateContactSelection();
        }

        function selectFirst3() {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach((cb, index) => cb.checked = index < 3);
            updateContactSelection();
        }

        function toggleSending() {
            if (isSending) {
                stopSending();
            } else {
                startSending();
            }
        }

        function stopSending() {
            shouldStop = true;
            isSending = false;
            
            document.getElementById('sendButton').textContent = 'üöÄ Mesaj + Bro≈ü√ºr G√∂ndermeyi Ba≈ülat';
            document.getElementById('sendButton').disabled = false;
            document.getElementById('sendButton').className = 'w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-medium';
            document.getElementById('stopButton').style.display = 'none';
            document.getElementById('progressText').textContent = 'G√∂nderim durduruldu.';
        }

        async function startSending() {
            const template = document.getElementById('messageTemplate').value;
            const delay = parseInt(document.getElementById('delayInput').value);
            
            // Get selected contacts
            const selectedContacts = [];
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const index = parseInt(cb.value);
                    selectedContacts.push(contacts[index]);
                }
            });
            
            if (!template) {
                alert('L√ºtfen mesaj ≈üablonu se√ßin!');
                return;
            }
            
            if (selectedContacts.length === 0) {
                alert('L√ºtfen en az bir ki≈üi se√ßin!');
                return;
            }

            // Set sending state
            isSending = true;
            shouldStop = false;
            
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('sendButton').textContent = '‚è∏Ô∏è G√∂nderim Devam Ediyor...';
            document.getElementById('sendButton').className = 'w-full bg-gray-600 text-white py-3 px-4 rounded-lg cursor-not-allowed font-medium';
            document.getElementById('stopButton').style.display = 'block';
            
            let sent = 0;
            let failed = 0;

            for (let i = 0; i < selectedContacts.length; i++) {
                // Check if user wants to stop
                if (shouldStop) {
                    document.getElementById('progressText').textContent = 'G√∂nderim durduruldu.';
                    break;
                }
                
                const contact = selectedContacts[i];
                const personalizedMessage = template.replace('{name}', contact.name);
                
                // Client-side phone validation
                const cleanPhone = contact.phone.replace(/[^\d+]/g, '');
                if (cleanPhone.length < 10) {
                    console.warn(`Invalid phone number: ${contact.name} -> ${contact.phone}`);
                    failed++;
                    continue;
                }
                
                try {
                    const response = await fetch(`/message/sendText/${currentInstance}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            number: contact.phone,
                            text: personalizedMessage,
                            delay: delay,
                            attachments: selectedFiles // √áoklu dosya desteƒüi
                        })
                    });

                    if (response.ok) {
                        sent++;
                        const data = await response.json();
                        console.log('Message sent:', data);
                    } else {
                        failed++;
                        const errorData = await response.json();
                        console.error('Send failed:', errorData);
                    }
                } catch (error) {
                    failed++;
                    console.error('Request error:', error);
                }

                const progress = ((i + 1) / selectedContacts.length) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                
                const attachmentStatus = selectedFiles.length > 0 ? ` (üìé ${selectedFiles.length} ek ile)` : '';
                document.getElementById('progressText').textContent = 
                    `ƒ∞lerleme: ${i + 1}/${selectedContacts.length}${attachmentStatus} - Ba≈üarƒ±lƒ±: ${sent}, Ba≈üarƒ±sƒ±z: ${failed}`;
                
                if (i < selectedContacts.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * 1000));
                }
            }

            // Reset sending state
            isSending = false;
            shouldStop = false;
            
            const attachmentSummary = selectedFiles.length > 0 ? ` + ${selectedFiles.length} ek` : '';
            document.getElementById('progressText').textContent = 
                `‚úÖ G√∂nderim tamamlandƒ±! Ba≈üarƒ±lƒ±: ${sent}, Ba≈üarƒ±sƒ±z: ${failed}${attachmentSummary}`;
            
            document.getElementById('sendButton').textContent = 'üöÄ Mesaj + Bro≈ü√ºr G√∂ndermeyi Ba≈ülat';
            document.getElementById('sendButton').disabled = false;
            document.getElementById('sendButton').className = 'w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-medium';
            document.getElementById('stopButton').style.display = 'none';
        }

        // File Upload Functions
        document.getElementById('fileUploadInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
            });

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${result.count} dosya ba≈üarƒ±yla y√ºklendi!`);
                    loadAvailableFiles();
                } else {
                    alert('‚ùå Upload hatasƒ±: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Upload hatasƒ±: ' + error.message);
            }
        });

        // Load available files as checkboxes
        async function loadAvailableFiles() {
            try {
                const response = await fetch('/api/files');
                const result = await response.json();
                
                const container = document.getElementById('availableFilesList');
                if (!container) {
                    console.warn('availableFilesList element not found');
                    return;
                }
                
                container.innerHTML = '';
                
                result.files.forEach(file => {
                    const icon = getFileIcon(file.originalname);
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2';
                    div.innerHTML = `
                        <input type="checkbox" id="file_${file.filename}" class="file-checkbox" value="${file.filename}" onchange="updateSelectedFiles()">
                        <label for="file_${file.filename}" class="text-sm cursor-pointer">${icon} ${file.originalname} (${formatFileSize(file.size)})</label>
                    `;
                    container.appendChild(div);
                });
                
                updateSelectedFiles();
            } catch (error) {
                console.error('Files loading error:', error);
            }
        }

        // Get file icon
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'üñºÔ∏è';
            if (['mp4', 'mov', 'avi', 'mkv'].includes(ext)) return 'üé•';
            if (ext === 'pdf') return 'üìÑ';
            if (['doc', 'docx'].includes(ext)) return 'üìù';
            if (['mp3', 'wav'].includes(ext)) return 'üéµ';
            return 'üìé';
        }

        // Update selected files
        function updateSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            selectedFiles = [];
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedFiles.push(cb.value);
                }
            });
            
            const display = document.getElementById('selectedFilesDisplay');
            const list = document.getElementById('selectedFilesList');
            
            if (display && list) {
                if (selectedFiles.length > 0) {
                    display.classList.remove('hidden');
                    list.innerHTML = selectedFiles.map(filename => {
                        const icon = getFileIcon(filename);
                        return `<div class="flex items-center justify-between bg-blue-50 p-2 rounded">
                            <span class="text-sm">${icon} ${filename}</span>
                            <button onclick="removeSelectedFile('${filename}')" class="text-red-500 hover:text-red-700 text-xs">‚ùå</button>
                        </div>`;
                    }).join('');
                } else {
                    display.classList.add('hidden');
                }
            }
        }

        // Remove selected file
        function removeSelectedFile(filename) {
            const checkbox = document.getElementById(`file_${filename}`);
            if (checkbox) {
                checkbox.checked = false;
                updateSelectedFiles();
            }
        }

        // Clear all selected files
        function clearSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedFiles();
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Error handling for browser extensions
        window.addEventListener('error', function(e) {
            // Suppress browser extension errors
            if (e.error && e.error.message && 
                (e.error.message.includes('runtime.lastError') || 
                 e.error.message.includes('Receiving end does not exist') ||
                 e.error.message.includes('chrome-extension') ||
                 e.error.message.includes('Could not establish connection'))) {
                console.log('Suppressed extension error:', e.error.message);
                e.preventDefault();
                return false;
            }
        });

        // Promise rejection handling for extensions
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && 
                (e.reason.message.includes('runtime.lastError') || 
                 e.reason.message.includes('Receiving end does not exist') ||
                 e.reason.message.includes('chrome-extension') ||
                 e.reason.message.includes('Could not establish connection'))) {
                console.log('Suppressed extension promise rejection:', e.reason.message);
                e.preventDefault();
                return false;
            }
        });

        // Load files on page load
        window.addEventListener('load', loadAvailableFiles);
    </script>
</body>
</html>