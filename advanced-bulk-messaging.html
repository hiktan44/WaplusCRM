<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRCHIEFS Geli≈ümi≈ü Toplu Mesaj Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF.js for PDF first-page thumbnail preview -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (window['pdfjsLib']) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <style>
        .file-drop-zone {
            border: 2px dashed #cbd5e0;
            transition: border-color 0.2s;
        }
        .file-drop-zone.dragover {
            border-color: #3182ce;
            background-color: #ebf8ff;
        }
        .contact-checkbox:checked + label {
            background-color: #3182ce;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üöÄ HAIRCHIEFS Geli≈ümi≈ü Toplu Mesaj</h1>
                    <p class="text-gray-600">Profesyonel mesajla≈üma, dosya y√ºkleme ve se√ßmeli g√∂nderim sistemi</p>
                </div>

                <div class="grid xl:grid-cols-3 gap-8">
                    
                    <!-- Left Panel: Contacts & Files -->
                    <div class="xl:col-span-1 space-y-6">
                        
                        <!-- File Upload Section -->
                        <div class="bg-blue-50 rounded-xl p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <span class="text-2xl mr-2">üìÅ</span>
                                Dosya Y√∂netimi
                            </h2>
                            
                            <div class="space-y-4">
                                <div id="dropZone" class="file-drop-zone rounded-lg p-6 text-center cursor-pointer">
                                    <div class="text-4xl mb-2">üì§</div>
                                    <p class="text-gray-600 mb-2">Dosyalarƒ± s√ºr√ºkle-bƒ±rak veya tƒ±kla</p>
                                    <p class="text-xs text-gray-500">Max: 250MB, 10 dosya</p>
                                    <input type="file" id="fileInput" multiple class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.mp3,.wav,.zip,.rar">
                                </div>
                                
                                <div id="uploadProgress" class="hidden">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <p id="progressText" class="text-sm text-gray-600 mt-1"></p>
                                </div>
                                
                                <div id="fileList" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Uploaded files will appear here -->
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="document.getElementById('manualFileInput').click()" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200">
                                        üì§ Dosya Y√ºkle
                                    </button>
                                    <button onclick="loadUploadedFiles()" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                                        üîÑ Listele
                                    </button>
                                </div>
                                
                                <input type="file" id="manualFileInput" multiple class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.mp3,.wav,.zip,.rar">
                            </div>
                        </div>

                        <!-- Contact Import Section -->
                        <div class="bg-green-50 rounded-xl p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <span class="text-2xl mr-2">üë•</span>
                                Ki≈üi Listesi
                            </h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">CSV/Excel Dosyasƒ±</label>
                                    <input type="file" id="contactFileInput" accept=".csv,.xlsx,.xls" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Manuel Giri≈ü</label>
                                    <textarea id="manualInput" rows="3" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                              placeholder="ƒ∞sim,Telefon&#10;Ahmet,905551234567"></textarea>
                                </div>
                                
                                <button onclick="loadContacts()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200">
                                    üìù Ki≈üileri Y√ºkle
                                </button>
                                
                                <div id="contactSummary" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Middle Panel: Message & Attachments -->
                    <div class="xl:col-span-1 space-y-6">
                        
                        <div class="bg-purple-50 rounded-xl p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <span class="text-2xl mr-2">üí¨</span>
                                Mesaj & Ekler
                            </h2>
                            
                            <div class="space-y-4">
                                <select id="templateSelect" onchange="selectTemplate()" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="">≈ûablon Se√ßin...</option>
                                    <option value="partnership">ü§ù Ortaklƒ±k Fƒ±rsatƒ±</option>
                                    <option value="promotion">‚úÇÔ∏è Sa√ß Ekimi Promosyonu</option>
                                    <option value="consultation">üë®‚Äç‚öïÔ∏è √úcretsiz Kons√ºltasyon</option>
                                    <option value="success">‚≠ê Ba≈üarƒ± Hikayesi</option>
                                </select>
                                
                                <textarea id="messageTemplate" rows="8" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                          placeholder="Mesajƒ±nƒ±zƒ± buraya yazƒ±n..."></textarea>

                                <!-- Templates Library -->
                                <div class="bg-white rounded-lg border p-4">
                                    <h3 class="text-sm font-semibold text-gray-700 mb-2">üìö ≈ûablonlar</h3>
                                    <div class="grid md:grid-cols-3 gap-2">
                                        <select id="templateLibrary" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
                                        <button onclick="applySelectedTemplate()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Uygula</button>
                                        <button onclick="deleteSelectedTemplate()" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Sil</button>
                                    </div>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <button onclick="saveCurrentAsTemplate()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Mevcut Metni Kaydet</button>
                                        <button onclick="createNewTemplate()" class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800">Yeni ≈ûablon Ekle</button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üìé Eklenecek Dosyalar</label>
                                    <div id="attachmentList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-3">
                                        <p class="text-gray-500 text-sm">Hen√ºz dosya se√ßilmedi</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">G√∂nderim Aralƒ±ƒüƒ±</label>
                                        <input type="number" id="delayInput" value="5" min="1" max="60"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Instance Adƒ±</label>
                                        <input type="text" id="instanceName" value="hairchiefs-wa" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">API Base URL</label>
                                    <input type="text" id="apiBaseUrl" value="" placeholder="√ñrn: https://alanadiniz.com"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <p class="text-xs text-gray-500 mt-1">Bo≈ü bƒ±rakƒ±lƒ±rsa sayfanƒ±n bulunduƒüu origin kullanƒ±lƒ±r</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Contact Selection & Sending -->
                    <div class="xl:col-span-1 space-y-6">
                        
                        <!-- Contact Selection -->
                        <div class="bg-yellow-50 rounded-xl p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <span class="text-2xl mr-2">üéØ</span>
                                G√∂nderim Se√ßenekleri
                            </h2>
                            
                            <div class="space-y-4">
                                <div class="flex space-x-2">
                                    <button onclick="selectTestGroup()" class="flex-1 bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600 text-sm">
                                        üß™ ƒ∞lk 3 Ki≈üi (Test)
                                    </button>
                                    <button onclick="selectAllContacts()" class="flex-1 bg-green-500 text-white py-2 px-3 rounded-md hover:bg-green-600 text-sm">
                                        üë• T√ºm√ºn√º Se√ß
                                    </button>
                                    <button onclick="clearSelection()" class="flex-1 bg-gray-500 text-white py-2 px-3 rounded-md hover:bg-gray-600 text-sm">
                                        üóëÔ∏è Temizle
                                    </button>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ki≈üi Se√ßimi</label>
                                    <div id="contactSelection" class="max-h-60 overflow-y-auto border border-gray-300 rounded-md p-3 space-y-2">
                                        <p class="text-gray-500 text-sm">√ñnce ki≈üileri y√ºkleyin</p>
                                    </div>
                                </div>
                                
                                <div id="selectionSummary" class="text-sm bg-white p-3 rounded-md border">
                                    <p class="font-medium">Se√ßim √ñzeti:</p>
                                    <p id="selectedCount">Se√ßili: 0 ki≈üi</p>
                                    <p id="attachmentCount">Dosya: 0 ek</p>
                                </div>
                            </div>
                        </div>

                        <!-- Progress & Send -->
                        <div class="bg-red-50 rounded-xl p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <span class="text-2xl mr-2">üöÄ</span>
                                G√∂nderim
                            </h2>
                            
                            <div class="space-y-4">
                                <div id="sendingProgress" class="hidden">
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div id="sendProgressBar" class="bg-green-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                    <p id="sendProgressText" class="text-sm text-gray-600 mt-2"></p>
                                </div>
                                
                                <button id="sendButton" onclick="startSending()" disabled 
                                        class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-4 px-6 rounded-lg hover:from-green-600 hover:to-blue-600 transition duration-200 font-bold disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed">
                                    üöÄ Mesaj G√∂ndermeyi Ba≈ülat
                                </button>
                                
                                <div id="sendResults" class="hidden text-sm">
                                    <div class="bg-white p-4 rounded-md border">
                                        <p class="font-medium mb-2">G√∂nderim Sonu√ßlarƒ±:</p>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="text-green-600">
                                                <span class="font-bold" id="successCount">0</span> Ba≈üarƒ±lƒ±
                                            </div>
                                            <div class="text-red-600">
                                                <span class="font-bold" id="failureCount">0</span> Ba≈üarƒ±sƒ±z
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let contacts = [];
        let selectedContacts = [];
        let uploadedFiles = [];
        let selectedAttachments = [];

        // Template messages
        const templates = {
            partnership: `üí´ Merhaba {name}! ‚ú®

üî• HAIRCHIEFS'ten size √ñZEL fƒ±rsat! 

üéØ KUAF√ñR ORTAKLIK PROGRAMI
‚úÖ %20'ye varan komisyon oranƒ±  
‚úÖ 50.000‚Ç∫ kredi imkanƒ± (6 taksit)
‚úÖ 8 yƒ±llƒ±k deneyim & 30.000+ ba≈üarƒ±lƒ± i≈ülem
‚úÖ 4000 m¬≤ alan & modern teknoloji

üìé Detaylƒ± bilgi ekte!

üì± Hemen ileti≈üim: ‚òéÔ∏è 0850 205 02 73

#HAIRCHIEFS #Sa√ßEkimi #Ortaklƒ±k`,

            promotion: `üåü Merhaba {name}! 

‚úÇÔ∏è HAIRCHIEFS √ñZEL KAMPANYA! 

üéÅ SADECE BU AY:
‚úÖ Sa√ß ekiminde %25 indirim
‚úÖ √úcretsiz sa√ß analizi  
‚úÖ 12 ay garanti
‚úÖ VIP transfer hizmeti

üë®‚Äç‚öïÔ∏è 8 yƒ±llƒ±k tecr√ºbe ile 30.000+ memnun hasta!

üìé Kampanya detaylarƒ± ekte!

üìû Randevu: ‚òéÔ∏è 0850 205 02 73

#HAIRCHIEFS #Sa√ßEkimi #Kampanya`,

            consultation: `üëã Merhaba {name}!

üë®‚Äç‚öïÔ∏è √úCRETSIZ UZMAN KONS√úLTASYONU

üî¨ HAIRCHIEFS'ten size √∂zel:
‚úÖ Sa√ß d√∂k√ºlmesi analizi
‚úÖ Ki≈üisel tedavi planƒ±
‚úÖ 3D sa√ß sim√ºlasyonu  
‚úÖ Fiyat bilgilendirme

üè• 30.000+ ba≈üarƒ±lƒ± operasyon tecr√ºbesi
‚≠ê 4.9 Google puanƒ± ile g√ºvenilir hizmet

üìé Hizmetlerimiz hakkƒ±nda detaylar ekte!

üì± √úcretsiz analiz: ‚òéÔ∏è 0850 205 02 73

#HAIRCHIEFS #Sa√ßAnalizi #√úcretsizKons√ºltasyon`,

            success: `üéâ Merhaba {name}!

‚≠ê HAIRCHIEFS BA≈ûARI Hƒ∞KAYESƒ∞

üìà 8 yƒ±llƒ±k tecr√ºbemizle:
‚úÖ 30.000+ memnun hasta
‚úÖ %99 ba≈üarƒ± oranƒ±
‚úÖ 4.9 Google yorumu
‚úÖ Doƒüal g√∂r√ºn√ºm garantisi

üí¨ "Hayalindeki sa√ßlara kavu≈ütum!" 
- Memnun hastalarƒ±mƒ±zdan...

üìé Ba≈üarƒ± hikayelerimiz ekte!

üèÜ T√ºrkiye'nin en g√ºvenilir sa√ß ekimi merkezi

üìû Siz de aramƒ±za katƒ±lƒ±n: ‚òéÔ∏è 0850 205 02 73

#HAIRCHIEFS #Ba≈üarƒ±Hikayesi #Sa√ßEkimi`
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Advanced page initializing...');
            setupFileUpload();
            loadUploadedFiles();
            // Default API base to current origin if input is empty
            const apiInput = document.getElementById('apiBaseUrl');
            if (apiInput && !apiInput.value) {
                apiInput.value = window.location.origin;
            }
            
            // Debug: Show if files exist
            setTimeout(() => {
                console.log('üìÑ Uploaded files:', uploadedFiles);
            }, 1000);

            ensureDefaultBusinessTemplates();
            refreshTemplateLibrary();
        });

        // File Upload Setup
        function setupFileUpload() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const manualFileInput = document.getElementById('manualFileInput');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                uploadFiles(files);
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                uploadFiles(files);
            });

            // Manual file upload button
            manualFileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                uploadFiles(files);
            });
        }

        // Upload Files
        async function uploadFiles(files) {
            if (files.length === 0) return;

            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
            });

            document.getElementById('uploadProgress').classList.remove('hidden');
            
            try {
                const base = (document.getElementById('apiBaseUrl')?.value || window.location.origin).trim();
                const response = await fetch(`${base}/api/upload`, {
                    method: 'POST',
                    headers: {
                        'x-tenant': (localStorage.getItem('tenantId') || 'public'),
                        'x-api-key': (localStorage.getItem('apiKey') || '')
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('progressText').textContent = `‚úÖ ${result.count} dosya ba≈üarƒ±yla y√ºklendi!`;
                    document.getElementById('progressBar').style.width = '100%';
                    
                    setTimeout(() => {
                        document.getElementById('uploadProgress').classList.add('hidden');
                        loadUploadedFiles();
                    }, 2000);
                } else {
                    alert('Upload hatasƒ±: ' + result.error);
                }
            } catch (error) {
                alert('Upload hatasƒ±: ' + error.message);
            }
        }

        // Load Uploaded Files
        async function loadUploadedFiles() {
            try {
                const base = (document.getElementById('apiBaseUrl')?.value || window.location.origin).trim();
                const response = await fetch(`${base}/api/files`, {
                    headers: {
                        'x-tenant': (localStorage.getItem('tenantId') || 'public'),
                        'x-api-key': (localStorage.getItem('apiKey') || '')
                    }
                });
                const result = await response.json();
                
                uploadedFiles = result.files || [];
                displayFileList();
                updateAttachmentOptions();
            } catch (error) {
                console.error('Load files error:', error);
            }
        }

        // Display File List
        function displayFileList() {
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '<p class="text-gray-500 text-sm">Hen√ºz dosya y√ºklenmemi≈ü</p>';
                return;
            }

            fileList.innerHTML = uploadedFiles.map(file => `
                <div class="bg-white p-3 rounded-md border flex justify-between items-center text-sm">
                    <div>
                        <p class="font-medium">${file.originalname}</p>
                        <p class="text-gray-500">${formatFileSize(file.size)} - ${formatDate(file.uploadDate)}</p>
                    </div>
                    <button onclick="deleteFile('${file.filename}')" class="text-red-500 hover:text-red-700">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        // Update Attachment Options
        function updateAttachmentOptions() {
            const attachmentList = document.getElementById('attachmentList');
            
            if (uploadedFiles.length === 0) {
                attachmentList.innerHTML = '<p class="text-gray-500 text-sm">Hen√ºz dosya se√ßilmedi</p>';
                return;
            }

            attachmentList.innerHTML = uploadedFiles.map((file, idx) => {
                const isPdf = (file.originalname || '').toLowerCase().endsWith('.pdf');
                const canvasId = `pdf_prev_${idx}`;
                const fileUrl = `/uploads/${file.filename}`;
                const preview = isPdf
                    ? `<a href="${fileUrl}" target="_blank" class="flex items-center space-x-3">
                           <canvas id="${canvasId}" class="bg-white rounded border" style="width:64px;height:90px"></canvas>
                           <span class="text-sm break-all">${file.originalname}</span>
                       </a>`
                    : `<a href="${fileUrl}" target="_blank" class="text-sm break-all">${file.originalname}</a>`;
                return `
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded cursor-pointer">
                        <input type="checkbox" value="${file.filename}" onchange="toggleAttachment('${file.filename}')" class="attachment-checkbox">
                        ${preview}
                    </label>
                `;
            }).join('');

            // Render thumbnails for PDFs
            uploadedFiles.forEach((file, idx) => {
                if ((file.originalname || '').toLowerCase().endsWith('.pdf')) {
                    renderPdfThumbnail(`/uploads/${file.filename}`, `pdf_prev_${idx}`);
                }
            });
        }

        // Toggle Attachment Selection
        function toggleAttachment(filename) {
            const checkbox = document.querySelector(`input[value="${filename}"]`);
            
            if (checkbox.checked) {
                if (!selectedAttachments.includes(filename)) {
                    selectedAttachments.push(filename);
                }
            } else {
                selectedAttachments = selectedAttachments.filter(f => f !== filename);
            }
            
            updateSelectionSummary();
        }

        // Delete File
        async function deleteFile(filename) {
            if (!confirm('Bu dosyayƒ± silmek istediƒüinizden emin misiniz?')) return;

            try {
                const base = (document.getElementById('apiBaseUrl')?.value || window.location.origin).trim();
                const response = await fetch(`${base}/api/files/${filename}`, {
                    method: 'DELETE',
                    headers: {
                        'x-tenant': (localStorage.getItem('tenantId') || 'public'),
                        'x-api-key': (localStorage.getItem('apiKey') || '')
                    }
                });
                
                if (response.ok) {
                    loadUploadedFiles();
                } else {
                    alert('Dosya silinirken hata olu≈ütu');
                }
            } catch (error) {
                alert('Silme hatasƒ±: ' + error.message);
            }
        }

        // Contact Management
        function selectTemplate() {
            const templateKey = document.getElementById('templateSelect').value;
            if (templateKey && templates[templateKey]) {
                document.getElementById('messageTemplate').value = templates[templateKey];
            }
        }

        function loadContacts() {
            contacts = [];
            
            const fileInput = document.getElementById('contactFileInput');
            const manualInput = document.getElementById('manualInput').value.trim();
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        if (file.name.endsWith('.csv')) {
                            parseCSV(e.target.result);
                        } else {
                            parseExcel(e.target.result);
                        }
                    } catch (error) {
                        alert('Dosya okuma hatasƒ±: ' + error.message);
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            } else if (manualInput) {
                parseCSV(manualInput);
            } else {
                alert('L√ºtfen dosya y√ºkleyin veya manuel olarak ki≈üi girin!');
            }
        }

        function looksLikeName(text) {
            if (!text) return false;
            const s = text.toString().trim();
            if (s.length < 2) return false;
            // Ignore if mostly numbers/coordinates or known generic values
            if (/^[-+\d.,\s]+$/.test(s)) return false;
            // Require at least one letter (TR chars included)
            return /[A-Za-z√áƒûƒ∞√ñ≈û√ú√ßƒüƒ±√∂≈ü√º]/.test(s);
        }

        function normalizePhone(raw) {
            if (!raw) return '';
            let p = raw.toString().replace(/[^\d+]/g, '');
            if (p.startsWith('+')) p = p.substring(1);
            if (p.startsWith('0') && p.length === 11) p = '9' + p;
            else if (p.startsWith('5') && p.length === 10) p = '90' + p;
            else if (!p.startsWith('90') && p.length === 10) p = '90' + p;
            return p;
        }

        function chooseName(parts, phoneIdx) {
            // Prefer first meaningful text cell before phone column
            for (let i = 0; i < parts.length; i++) {
                if (i === phoneIdx) continue;
                const val = (parts[i] ?? '').toString().trim();
                if (looksLikeName(val)) return val.substring(0, 80);
            }
            // Fallback to first column
            const first = (parts[0] ?? '').toString().trim();
            return first ? first.substring(0, 80) : 'Kayƒ±tsƒ±z';
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            contacts = [];
            
            // Header tespiti: ilk satƒ±rda 10+ rakam yoksa ba≈ülƒ±k kabul et
            let startIndex = 0;
            if (lines.length > 0 && !/\d{10,}/.test(lines[0])) {
                startIndex = 1;
            }
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                const parts = line.split(',').map(s => s.trim());
                let phoneIdx = -1;
                let phone = '';
                for (let j = 0; j < parts.length; j++) {
                    const normalized = normalizePhone(parts[j]);
                    if (normalized.length >= 10) { phoneIdx = j; phone = normalized; break; }
                }
                let name = chooseName(parts, phoneIdx);
                
                if (name && phone && phone.length >= 10) {
                    contacts.push({ id: contacts.length, name, phone, selected: false });
                }
            }
            
            updateContactDisplay();
        }

        function parseExcel(binaryStr) {
            const workbook = XLSX.read(binaryStr, { type: 'binary' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            contacts = [];
            
            // Header tespiti: ilk satƒ±rda 10+ rakam yoksa ba≈ülƒ±k kabul et
            let startIndex = 0;
            if (data.length > 0) {
                const firstRow = data[0] || [];
                const hasPhoneLike = firstRow.some(c => (c || '').toString().replace(/\D/g, '').length >= 10);
                if (!hasPhoneLike) startIndex = 1;
            }
            
            for (let i = startIndex; i < data.length; i++) {
                const row = data[i] || [];
                if (!row || row.length === 0) continue;
                
                // Telefon h√ºcresini otomatik bul
                let phoneIdx = -1;
                let phone = '';
                for (let j = 0; j < row.length; j++) {
                    const cleaned = normalizePhone(row[j]);
                    if (cleaned.length >= 10) { phoneIdx = j; phone = cleaned; break; }
                }

                // ƒ∞sim i√ßin uygun bir h√ºcre se√ß
                const name = chooseName(row, phoneIdx);
                
                if (name && phone && phone.length >= 10) {
                    contacts.push({ id: contacts.length, name, phone, selected: false });
                }
            }
            
            updateContactDisplay();
        }

        // Contact Selection Functions
        function selectTestGroup() {
            contacts.forEach((contact, index) => {
                contact.selected = index < 3;
            });
            updateContactDisplay();
        }

        function selectAllContacts() {
            contacts.forEach(contact => {
                contact.selected = true;
            });
            updateContactDisplay();
        }

        function clearSelection() {
            contacts.forEach(contact => {
                contact.selected = false;
            });
            updateContactDisplay();
        }

        function toggleContact(id) {
            const contact = contacts.find(c => c.id === id);
            if (contact) {
                contact.selected = !contact.selected;
                updateContactDisplay();
            }
        }

        function updateContactDisplay() {
            const contactSelection = document.getElementById('contactSelection');
            const contactSummary = document.getElementById('contactSummary');
            
            if (contacts.length === 0) {
                contactSelection.innerHTML = '<p class="text-gray-500 text-sm">√ñnce ki≈üileri y√ºkleyin</p>';
                contactSummary.innerHTML = '';
                return;
            }

            contactSelection.innerHTML = contacts.map(contact => `
                <label class="flex items-center space-x-2 p-2 hover:bg-gray-100 rounded cursor-pointer ${contact.selected ? 'bg-blue-100' : ''}">
                    <input type="checkbox" ${contact.selected ? 'checked' : ''} 
                           onchange="toggleContact(${contact.id})" class="contact-checkbox">
                    <span class="text-sm flex-1">${contact.name} - ${contact.phone}</span>
                </label>
            `).join('');

            contactSummary.innerHTML = `üìä Toplam: ${contacts.length} ki≈üi y√ºklendi`;
            
            updateSelectionSummary();
            updateSendButton();
        }

        function updateSelectionSummary() {
            const selectedCount = contacts.filter(c => c.selected).length;
            const attachmentCount = selectedAttachments.length;
            
            document.getElementById('selectedCount').textContent = `Se√ßili: ${selectedCount} ki≈üi`;
            document.getElementById('attachmentCount').textContent = `Dosya: ${attachmentCount} ek`;
        }

        function updateSendButton() {
            const selectedCount = contacts.filter(c => c.selected).length;
            const messageText = document.getElementById('messageTemplate').value.trim();
            
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = selectedCount === 0 || messageText === '';
            
            if (selectedCount > 0 && messageText) {
                sendButton.innerHTML = `üöÄ ${selectedCount} Ki≈üiye Mesaj G√∂nder`;
            } else {
                sendButton.innerHTML = 'üöÄ Mesaj G√∂ndermeyi Ba≈ülat';
            }
        }

        // Start Sending Messages
        async function startSending() {
            const selectedContactList = contacts.filter(c => c.selected);
            const messageText = document.getElementById('messageTemplate').value.trim();
            const delay = parseInt(document.getElementById('delayInput').value);
            const instanceName = document.getElementById('instanceName').value;
            
            if (selectedContactList.length === 0) {
                alert('L√ºtfen en az bir ki≈üi se√ßin!');
                return;
            }
            
            if (!messageText) {
                alert('L√ºtfen mesaj yazƒ±n!');
                return;
            }

            document.getElementById('sendingProgress').classList.remove('hidden');
            document.getElementById('sendButton').disabled = true;
            
            let successCount = 0;
            let failureCount = 0;

            for (let i = 0; i < selectedContactList.length; i++) {
                const contact = selectedContactList[i];
                const personalizedMessage = messageText.replace('{name}', contact.name);
                
                try {
                    const base = (document.getElementById('apiBaseUrl')?.value || window.location.origin).trim();
                    for (const attachmentFilename of selectedAttachments) {
                        const response = await fetch(`${base}/message/sendText/${instanceName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-tenant': (localStorage.getItem('tenantId') || 'public'),
                                'x-api-key': (localStorage.getItem('apiKey') || '')
                            },
                            body: JSON.stringify({
                                number: contact.phone,
                                text: personalizedMessage,
                                delay: delay,
                                attachment: attachmentFilename
                            })
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            failureCount++;
                        }
                        
                        // Small delay between attachments
                        if (selectedAttachments.length > 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    
                    // If no attachments, send text only
                    if (selectedAttachments.length === 0) {
                        const base = (document.getElementById('apiBaseUrl')?.value || window.location.origin).trim();
                        const response = await fetch(`${base}/message/sendText/${instanceName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-tenant': (localStorage.getItem('tenantId') || 'public'),
                                'x-api-key': (localStorage.getItem('apiKey') || '')
                            },
                            body: JSON.stringify({
                                number: contact.phone,
                                text: personalizedMessage,
                                delay: delay
                            })
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            failureCount++;
                        }
                    }
                    
                } catch (error) {
                    failureCount++;
                }

                const progress = ((i + 1) / selectedContactList.length) * 100;
                document.getElementById('sendProgressBar').style.width = progress + '%';
                document.getElementById('sendProgressText').textContent = 
                    `ƒ∞lerleme: ${i + 1}/${selectedContactList.length} - Ba≈üarƒ±lƒ±: ${successCount}, Ba≈üarƒ±sƒ±z: ${failureCount}`;
                
                if (i < selectedContactList.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * 1000));
                }
            }

            // Show results
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('failureCount').textContent = failureCount;
            document.getElementById('sendResults').classList.remove('hidden');
            
            document.getElementById('sendProgressText').textContent = '‚úÖ G√∂nderim tamamlandƒ±!';
            document.getElementById('sendButton').disabled = false;
        }

        // Utility Functions
        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Byte';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('tr-TR');
        }

        // -----------------------------
        // Templates Library (localStorage)
        // -----------------------------
        const TEMPLATE_PREFIX = 'waPlusCRM_template_';

        function listStoredTemplates() {
            const items = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(TEMPLATE_PREFIX)) {
                    const name = key.replace(TEMPLATE_PREFIX, '');
                    try {
                        const raw = localStorage.getItem(key);
                        const data = JSON.parse(raw || '{}');
                        items.push({ name, content: data.content || '' });
                    } catch(_) {}
                }
            }
            // Sort by name
            items.sort((a,b) => a.name.localeCompare(b.name, 'tr'));
            return items;
        }

        function refreshTemplateLibrary() {
            const select = document.getElementById('templateLibrary');
            if (!select) return;
            const items = listStoredTemplates();
            select.innerHTML = items.length
                ? items.map(t => `<option value="${t.name}">${t.name}</option>`).join('')
                : '<option value="">(Kayƒ±tlƒ± ≈üablon yok)</option>';
        }

        function saveTemplateToStorage(name, content) {
            if (!name) return;
            const payload = { content: content || '', savedAt: new Date().toISOString() };
            localStorage.setItem(TEMPLATE_PREFIX + name, JSON.stringify(payload));
        }

        function deleteTemplateFromStorage(name) {
            localStorage.removeItem(TEMPLATE_PREFIX + name);
        }

        function applySelectedTemplate() {
            const select = document.getElementById('templateLibrary');
            if (!select || !select.value) return;
            const key = TEMPLATE_PREFIX + select.value;
            const raw = localStorage.getItem(key);
            if (!raw) return;
            const data = JSON.parse(raw);
            document.getElementById('messageTemplate').value = data.content || '';
            updateSendButton();
        }

        function deleteSelectedTemplate() {
            const select = document.getElementById('templateLibrary');
            if (!select || !select.value) return;
            if (!confirm('Se√ßili ≈üablonu silmek istiyor musunuz?')) return;
            deleteTemplateFromStorage(select.value);
            refreshTemplateLibrary();
        }

        function saveCurrentAsTemplate() {
            const name = prompt('≈ûablon adƒ±:');
            if (!name) return;
            const content = document.getElementById('messageTemplate').value.trim();
            if (!content) return alert('≈ûablon i√ßeriƒüi bo≈ü olamaz');
            saveTemplateToStorage(name, content);
            refreshTemplateLibrary();
            alert('≈ûablon kaydedildi');
        }

        function createNewTemplate() {
            const name = prompt('Yeni ≈üablon adƒ±:');
            if (!name) return;
            const content = prompt('≈ûablon metni ( {name} deƒüi≈ükenini kullanabilirsiniz ):');
            if (content === null) return;
            saveTemplateToStorage(name, content);
            refreshTemplateLibrary();
        }

        function ensureDefaultBusinessTemplates() {
            const defaults = [
                { n: 'ƒ∞≈ü-1 Kƒ±sa Tanƒ±≈üma', c: 'Merhaba {name}, ben HAIRCHIEFS‚Äôten yazƒ±yorum. Uygun olduƒüunuzda kƒ±saca tanƒ±≈üalƒ±m mƒ±?' },
                { n: 'ƒ∞≈ü-2 Deƒüer √ñnerisi', c: '{name}, i≈ületmelere √∂zel avantajlƒ± sa√ß ekimi paketlerimizi payla≈ümak isterim. 15 dakikalƒ±k bir g√∂r√º≈üme ayarlayabilir miyiz?' },
                { n: 'ƒ∞≈ü-3 Toplantƒ± Talebi', c: 'Selam {name}, bu hafta 10 dakikalƒ±k bir tanƒ±≈üma i√ßin uygun musunuz? Tarih √∂nerir misiniz?' },
                { n: 'ƒ∞≈ü-4 Referans Vurgusu', c: '{name}, 30.000+ ba≈üarƒ±lƒ± operasyon ve 4.9 puanla hizmet veriyoruz. Sizin i√ßin de ideal planƒ± konu≈üalƒ±m mƒ±?' },
                { n: 'ƒ∞≈ü-5 Kampanya Duyurusu', c: 'Sayƒ±n {name}, kƒ±sƒ±tlƒ± s√ºreli kurumsal kampanyamƒ±z ba≈üladƒ±. ƒ∞sterseniz detaylarƒ± PDF ile iletebilirim.' },
                { n: 'ƒ∞≈ü-6 Ortaklƒ±k Daveti', c: '{name}, kuaf√∂r/i≈ü ortaklƒ±ƒüƒ± programƒ±mƒ±zla ek gelir fƒ±rsatƒ± sunuyoruz. Kƒ±sa bir bilgi g√∂ndermemi ister misiniz?' },
                { n: 'ƒ∞≈ü-7 Fiyat Bilgilendirme', c: '{name}, ihtiyaca g√∂re paket fiyatlarƒ± ve esnek √∂deme se√ßenekleri mevcut. Hangi tarih sizin i√ßin uygun?' },
                { n: 'ƒ∞≈ü-8 Etkinlik Daveti', c: 'Merhaba {name}, √∂n√ºm√ºzdeki hafta tanƒ±tƒ±m etkinliƒüimiz var. Katƒ±lƒ±m i√ßin adƒ±nƒ±zƒ± yazdƒ±rayƒ±m mƒ±?' },
                { n: 'ƒ∞≈ü-9 Teklif Takibi', c: '{name}, √∂nceki teklifimizle ilgili sorunuz oldu mu? Yardƒ±mcƒ± olmaktan memnuniyet duyarƒ±z.' },
                { n: 'ƒ∞≈ü-10 Kapanƒ±≈ü/Nazik Hatƒ±rlatma', c: '{name}, uygun olduƒüunuzda yazabilirsiniz. Memnuniyetle destek oluruz. ƒ∞yi √ßalƒ±≈ümalar dileriz.' }
            ];
            // Yalnƒ±zca hi√ß ≈üablon yoksa y√ºkle
            const hasAny = listStoredTemplates().length > 0;
            if (hasAny) return;
            defaults.forEach(t => saveTemplateToStorage(t.n, t.c));
        }

        // Render first page of a PDF to canvas
        async function renderPdfThumbnail(url, canvasId) {
            try {
                if (!window['pdfjsLib']) return;
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 0.25 });
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: context, viewport }).promise;
            } catch (e) {
                console.warn('PDF preview render failed:', e);
            }
        }

        // Update send button when message changes
        document.getElementById('messageTemplate').addEventListener('input', updateSendButton);
    </script>
</body>
</html>